#!/bin/bash
echo "bookMaker compiler"

# Initialize variables
book_path=""
output_string=""
boolean_flag=false

# Function to print usage
usage() {
  echo "Usage: $0 -b=DIR | -book=DIR -o=STRING [-y]"
  exit 1
}

# Function to concatenate .md files
concatenate_md_files() {
  output_file="$1/book/$(basename "$book_path").md"
  mkdir -p "$1/book"  # Ensure the book directory exists
  cat "$book_path/src/SUMMARY.md" > "$output_file"
  find "$book_path/src" -type f -name "*.md" ! -name "SUMMARY.md" -exec cat {} + >> "$output_file"
  echo "$output_file"
}

# Function to convert using pandoc
convert_with_pandoc() {
  input_file=$1
  output_file="${input_file%.md}.$output_string"
  echo "Running pandoc to convert $input_file to $output_file"
  pandoc "$input_file" -o "$output_file"
  echo "Outputted $output_file"
}

# Placeholder function for Typst conversion
typstConv() {
  echo "Typst conversion function called."
  # Insert book.toml values into TEMPLATE.typ
  read_toml_value
  replace_template_values
  # Implement Typst conversion logic here
  ./md2typst -b=$book_path
}

# Placeholder function for LaTeX conversion
LaTexConv() {
  echo "LaTeX conversion function called."
  # Implement LaTeX conversion logic here
}

# Parse command-line arguments
for arg in "$@"; do
  case $arg in
    -b=*|--book=*)
      book_path="${arg#*=}"
      shift
      ;;
    -o=*|--out=*)
      output_string="${arg#*=}"
      shift
      ;;
    -y)
      boolean_flag=true
      shift
      ;;
    *)
      echo "Invalid argument: $arg"
      usage
      ;;
  esac
done

# Check if book_path is provided
if [ -z "$book_path" ]; then
  echo "Error: Book directory not specified"
  usage
fi

# Check if output_string is provided
if [ -z "$output_string" ]; then
  echo "Error: Output string not specified"
  usage
fi

# Check if the directory exists
if [ ! -d "$book_path" ]; then
  echo "Error: Directory '$book_path' does not exist"
  exit 1
fi

# Print out list of all subdirectories and files
echo "Listing all files and subdirectories in '$book_path':"
find "$book_path" -type d -print -o -type f -print

# Check for .md files
md_files=$(find "$book_path" -type f -name "*.md")
if [ -z "$md_files" ]; then
  echo "Error: No *.md files found in '$book_path'"
  exit 1
fi

# If -y flag is not set, prompt the user for confirmation
if ! $boolean_flag; then
  read -p "Do you wish to continue? (y/n) " user_response
  case $user_response in
    [Yy]* )
      echo "Continuing..."
      ;;
    * )
      echo "Aborting."
      exit 1
      ;;
  esac
fi

# Compile the .md files into one .md file
compiled_md_file=$(concatenate_md_files "$book_path")
echo "Compiled markdown file: $compiled_md_file"

# Check output string and perform appropriate action
case $output_string in
  md)
    # Already printed the compiled markdown file, no need to print again
    ;;
  pdf|odt|docx)
    convert_with_pandoc "$compiled_md_file"
    ;;
  tp|typst)
    typstConv
    ;;
  lt|latex)
    LaTexConv
    ;;
  *)
    echo "Error: Invalid output format '$output_string'"
    usage
    ;;
esac

#!/bin/bash

# add book.toml path from bookname/src/book.toml
# add TEMPLATE.typ path from bookname/book/$bookname.typ
# (don't change src/TEMPLATE.typ in case something changes)

# Function to read a value from a TOML file
get_toml_value() {
    local file=$1
    local key=$2
    # Extract the value using grep and sed
    local value=$(grep -oP "^$key\s*=\s*\"?\K[^\"]+" "$file")
    echo "$value"
}

read_toml_value() {

tomlpath="$book_path/src/book.toml"
# Read values from the book.toml file
title=$(get_toml_value "$tomlpath" "title")
authors=$(get_toml_value "$tomlpath" "authors")
description=$(get_toml_value "$tomlpath" "description")
copyright_year=$(get_toml_value "$tomlpath" "copyright-year")
this_edition=$(get_toml_value "$tomlpath" "this-edition")
printed_by=$(get_toml_value "$tomlpath" "printed-by")
contact_address=$(get_toml_value "$tomlpath" "contact-address")
website_address=$(get_toml_value "$tomlpath" "website-address")
page_size=$(get_toml_value "$tomlpath" "page-size")
outer_margin=$(get_toml_value "$tomlpath" "outer-margin")
inner_margin=$(get_toml_value "$tomlpath" "inner-margin")
header=$(get_toml_value "$tomlpath" "header")
footer=$(get_toml_value "$tomlpath" "footer")
contents=$(get_toml_value "$tomlpath" "contents")
cover_image=$(get_toml_value "$tomlpath" "cover-image")
}

# Print the values (for testing purposes)
# echo "title=$title"

replace_template_values() {
# Replace placeholders in TEMPLATE.typ
sed -i "s/{{\$title}}/$title/g" TEMPLATE.typ
sed -i "s/{{\$authors}}/$authors/g" TEMPLATE.typ
sed -i "s/{{\$description}}/$description/g" TEMPLATE.typ
sed -i "s/{{\$copyright_year}}/$copyright_year/g"
sed -i "s/{{\$this-edition}}/$this_edition/g" TEMPLATE.typ
sed -i "s/{{\$printed-by}}/$printed_by/g" TEMPLATE.typ
sed -i "s/{{\$contact_address}}/$contact_address/g" TEMPLATE.typ
sed -i "s/{{\$website_address}}/$website_address/g" TEMPLATE.typ
sed -i "s/{{\$page-size}}/$page_size/g" TEMPLATE.typ
sed -i "s/{{\$outer-margin}}/$outer_margin/g" TEMPLATE.typ
sed -i "s/{{\$inner-margin}}/$inner_margin/g" TEMPLATE.typ
sed -i "s/{{\$header}}/$header/g" TEMPLATE.typ
sed -i "s/{{\$footer}}/$footer/g" TEMPLATE.typ
sed -i "s/{{\$contents}}/$contents/g" TEMPLATE.typ
sed -i "s/{{\$cover-image}}/$cover_image/g" TEMPLATE.typ

# cover will need slightly different handling
}
